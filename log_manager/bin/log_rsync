#!/usr/bin/env ruby
# frozen_string_literal: true

# = log_rsync
# v1.0.1
# compatible with Ruby 2.0.0
#
# Copyright 2019 Kyoto University of Education
# The MIT License
# https://opensource.org/licenses/MIT

# TODO
# multiple sources required by ssh forced-commands-only

begin
  require 'log_manager/rsync'
rescue LoadError
  require_relative '../lib/log_manager/rsync'
end

if $0 == __FILE__
  require 'optparse'
  Version = '1.0.1'

  opt = OptionParser.new
  only_host = nil
  opt.on('-h HOST') { |v| only_host = v }
  opt.parse!(ARGV)

  config = LogManager::Utils.yaml_safe_load_symbolize(DATA)
  rsync = LogManager::Rsync.new(config)
  config[:hosts].each do |host|
    next if only_host && only_host != host[:name]

    host_save_dir = File.join(config[:save_dir], host[:name])
    host[:targets].each do |target|
      opts = {}
      %i[includes excludes].each do |key|
        opts[key] = target[key] if target[key]
      end
      rsync.sync(
        "#{host[:user]}@#{host[:host]}",
        target[:dir],
        File.join(host_save_dir, target[:name]),
        **opts
      )
    end
  end
end
